{% extends 'app/base.html' %}

{% block back_button_url %}{% url 'app:upload_selfie' %}?zodiac_id={{ zodiac.id }}{% endblock %}

{% block content %}
  {% load static %}
  <div class="loading-container">
    <div class="loading">
      <h3 id="loading-text">loading...</h3>
      <h4 id="loading-subtext">Your image is being generated! This may take up to 60 seconds.</h4>
    </div>
  </div>

  <div hidden class="result-container">
    <div>
      <h2 class="result title">I am Year of the <br>{{ zodiac.title | title }}!</h2>
      <div id="ai-image-container">
        <div id="ai-image-div">
        </div>
      </div>
      <a id="fortune-link">
        <h4>read your fortune <img src="{% static 'app/svg/next.svg' %}"></img></h4>
      </a>
    </div>
    <img id="gold-bullion" src="{% static 'app/images/gold_bullion.png' %}"></img>
  </div>

  <div hidden class="fortune-container">
    <div>

    </div>
  </div>

  <div class="credits-container">
    <div class="credits">
      <h2 class="credits title">CREDITS</h2>
      <p>
        John Tsung
        <br>
        Nicole Ciemniak
        <br>
        Koi
        <br>
        Hongru
      </p>
    </div>
  </div>

  <script>

    function checkMidjourneyTaskProgress() {
      // URL for the Django view
      domain = getDomain();
      http_protocol = getHttpProtocol();
      var djangoViewUrl = `${http_protocol}://${domain}/midjourney_task_progress?message_id={{ message_id }}`;

      // Make an AJAX call using the fetch API
      fetch(djangoViewUrl, {
        method: 'GET',
        mode: 'no-cors',
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Handle the data received from the Django view
        console.log('Data from Django:', data);
        
        if ('progress' in data && data.progress == 100) {
          displayGeneratedImage(data.uri);
          $('.loading-container').hide();
          $('.result-container').css('display', 'flex');
        }
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
    }

    function getDomain() {
      if (window.location.hostname == 'localhost' || window.location.hostname == '127.0.0.1') {
        return window.location.host;
      } else {
        return window.location.hostname;
      }
    }

    function getHttpProtocol() {
      if (window.location.hostname == 'localhost' || window.location.hostname == '127.0.0.1') {
        return 'http';
      } else {
        return 'https';
      }
    }

    function displayGeneratedImage(uri) {
      // Set background image
      $('#ai-image-div').css('background-image', 'url(' + uri + ')');
    }

    // poll the API every 3 seconds for generation progress
    var intervalId = setInterval(function () {
      checkMidjourneyTaskProgress();

      var isLoading = $('.result-container').is(':hidden');

      if (!isLoading) {
          clearInterval(intervalId);
      }
    }, 3000);

    // Clear the interval after a certain number of repetitions
    setTimeout(function() {
        clearInterval(intervalId);
    }, 300000); // Stop after 5 minutes
  </script>

{% endblock %}
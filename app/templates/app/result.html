{% extends 'app/base.html' %}

{% block back_button_url %}{% url 'app:upload_selfie' %}?zodiac_id={{ zodiac_id }}{% endblock %}

{% block content %}
  {% load static %}
  <div hidden class="result-container">
    <h2 class="result title">Your Zodiac Persona!</h2>
    <div id="ai-image-container">
      <div id="ai-image-div">
      </div>
    </div>
    <img id="gold-bullion" src="{% static 'app/images/gold_bullion.png' %}"></img>
  </div>

  <div class="loading-container">
    <div class="loading">
      <h3 id="loading-text">loading...</h3>
      <h4 id="loading-subtext">Your image is being generated! This may take up to 60 seconds.</h4>
    </div>

  </div>

  <script>

    function checkMidjourneyTaskProgress() {
      // URL for the Django view
      domain = getDomain();
      var djangoViewUrl = `http://${domain}/midjourney_task_progress?message_id={{ message_id }}`;

      // Make an AJAX call using the fetch API
      fetch(djangoViewUrl, {
        method: 'GET',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Handle the data received from the Django view
        console.log('Data from Django:', data);
        
        if (data.data !== 'loading') {
          displayGeneratedImage(data.data);
        }
      })
      .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
      });
    }

    function getDomain() {
      if (window.location.hostname == 'localhost' || window.location.hostname == '127.0.0.1') {
        return window.location.host;
      } else {
        return window.location.hostname;
      }
    }

    // poll the API every 3 seconds for generation progress
    var intervalId = setInterval(function () {
      // checkMidjourneyTaskProgress();

      var isLoading = $('#result-container').is(':hidden');

      if (!isLoading) {
          clearInterval(intervalId);
          console.log("Interval stopped");
      }
    }, 3000);

    // Clear the interval after a certain number of repetitions
    setTimeout(function() {
        clearInterval(intervalId);
    }, 30000); // Stop after 30 seconds

    function displayGeneratedImage(uri) {
      // Set background image
      $('#ai-image-div').css('background-image', 'url(' + uri + ')');
    }


    // test switch from loading to not  
    setInterval(function () {
      $('.loading-container').hide();
      $('.result-container').css('display', 'flex');
    }, 3000);
  </script>

{% endblock %}
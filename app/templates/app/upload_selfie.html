{% extends 'app/base.html' %}

{% block back_button_url %}{% url 'app:zodiac' %}?zodiac_id={{ zodiac_id }}{% endblock %}

{% block content %}
  {% load static %}

  <div class="upload-selfie-container">
    <div>
      <h2 class="upload-selfie title">
        See what you look like as your zodiac animal!
      </h2>
      <div class="btn-upload" onclick="triggerFileInput()">
        <h2 class="select-image">
          <img id="upload-image-icon" src="{% static 'app/svg/plus_sign.svg' %}"></img>
          <span>Choose your photo</span>
        </h2>
      </div>

      <form id="upload-image-form" hidden action="{% url 'app:result' %}?zodiac_id={{ zodiac_id }}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form }}
        <input type="hidden" id="zodiac_id" name='zodiac_id' value="{{ zodiac_id }}">
        <input type="hidden" id="uploaded_image_url" name='uploaded_image_url'>
        <button id="upload-image" hidden type="submit">Upload</button>
      </form>
    </div>
  </div>

  <script>
    function triggerFileInput() {
        $('#id_image').click();
    }

    $(document).ready(function() {
    // Upload to temporary location
    $('#id_image').change(function() {
      uploadImageToTempURL();

    });
  });

  function uploadImageToTempURL() {
    var fileInput = document.getElementById('id_image');
    
    // Check if a file is selected
    if (fileInput.files.length > 0) {
        var file = fileInput.files[0];

        // Create FormData object and append the file
        var formData = new FormData();
        formData.append('file', file, file.name);

        // Make a POST request using Fetch API
        fetch('https://tmpfiles.org/api/v1/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            initialUrl = data.data.url;
            var modifiedUrl = initialUrl.replace(/^(https?:\/\/[^\/]+)(\/.*)?$/, '$1/' + 'dl' + '$2');

            $('#uploaded_image_url').val(modifiedUrl);
            $('#upload-image').click();
        })
        .catch(error => {
            console.error('Error uploading image:', error);
        });
    } else {
        console.warn('No file selected.');
    }
}
  </script>
{% endblock %}